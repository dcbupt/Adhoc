# Adhoc

## 程序总体框架

### 主函数介绍
主函数完成启动μC/OS-II操作系统，初始化本节点参数信息和创建两个主进程和一个定时器进程，并通过启动μC/OS-II多任务调度环境实现adhoc链路层和网络层的协议

### 主进程介绍
两个主进程：Protocol进程和Recv_data_from_lvds进程。<br>
Protocol进程和Recv_data_from_lvds进程实现不同的分工，彼此又通过事件消息队列进行通信。<br>
（1）	Protocol进程：负责监听事件消息队列里的消息。当有新的消息进入队列，Protocol进程负责根据事件消息类型调用相应的处理接口实现链路层和网络层功能，即Protocol进程扮演的是事件的消费者，通过事件驱动的方式实现协议。<br>
（2）	Recv_data_from_lvds：负责监听LVDS接口的数据。当有数据到来时，Recv_data_from_lvds接口根据数据类型向事件消息队列发送不同类型的事件消息，即Recv_data_from_lvds进程扮演的是事件的生产者，读取物理层传来的数据交由Protocol进程实现上层协议

### 主定时器介绍
（1）	一个定时器进程：set_timer进程。<br>
（2）	负责延时固定时间后，向Protocol进程发送定时器到时事件，触发Protocol进程调用宽波束消息发送接口广播组网数据帧。

### 连通性矩阵更新策略
本节点根据自身天线接收到的信息判断周边可通信的节点，更新矩阵中与自身节点相关的矩阵元素，并通过接收别的节点发布的连通性矩阵，更新其它节点间的连通性元素信息。并在自身时隙时，将更新后的连通性矩阵发布出去，供其它节点更新。

### 宽波束消息发送
（1）	对应接口:send_node_msg   (接口位于mac_laye.c) <br>
（2）	在每个节点所属时隙，如果网络层缓存队列没有DATA且天线均处于宽波束状态，节点发送一次宽波束组网数据帧，广播本节点的位置信息、速度信息、时间信息、压缩后的连通矩阵。<br>
（3）	如果网络层有DATA且天线工作在宽波束，发送一次宽波束数传请求帧RTS，并携带建立窄波束通信的目的节点ID。<BR>

### 宽波束消息接收
（1）	对应接口：read_node_msg   (接口位于mac_laye.c) <br>
（2）	解析宽波束消息，更新邻居节点的位置、速度信息，确定相邻节点的位置。 <BR>
（3）	解析压缩后的全联通矩阵，更新本地连通矩阵。<BR>
（4）	启动定时器，如果定时器到时都没有再次收到该邻居节点的宽波束消息，认为这个节点不再是邻居节点。 <BR>
（5）	如果收到的是宽波束数传请求帧，判断目的节点是否为本节点，如果是，进行窄波束数传前的准备。<BR>

### 窄波束消息流程
（1）	当源节点有数据要发送时，在宽波束工作模式下，发送RTS=1的节点信息后，进入窄波束工作模式，等待CTS回复。<BR>
（2）	如果在源节点下一时隙到来时，仍未接收到信息，返回宽波束工作模式。<BR>
（3）	当目的节点收到源节点的RTS后，进入窄波束工作模式，发送CTS，等待数据接收。<BR>
（4）	源节点收到CTS后，开始发送数据。<BR>
（5）	目的节点对接收到的正确数据发送ACK给予证实。<BR>
（6）	源节点收到ACK后，如有数据，继续发送，如果没有，则发送END消息，返回宽波束工作模式结束发送。<BR>
（7）	目的节点收到END消息后，回复END消息，之后返回宽波束工作模式。<BR>
（8）	当接收节点的数据缓存队列BUF满时，回复ACK_OVERFLOW消息，返回宽波束工作模式。<BR>
（9）	发送节点收到ACK_OVERFLOW消息，返回宽波束工作模式。<BR>

## 网络层
### 接收应用层数据
应用层接收数据的接口：void packetProcess( uint8_t destID, void* point2data, uint32_t length);<BR>
参数说明：<BR>
destID: 数据发往的目标地址<BR>
point2data: 指向数据内存的地址<BR>
length: 数据块的长度<BR>
处理流程：<BR>
接口从应用层收到数据，根据目标地址，在路由表中查找下一跳地址，如果查到，则添加相应的网络层报头，然后调用MAC层提供的接口，将数据交接给MAC层进行处理；如果没有相应路由表项，则丢弃数据包，并通知MAC层启动全连通矩阵更新流程。<BR>

### 接收MAC层数据
接口定义：  receiveFromMac( void * point2data, uint32_t length);<BR>
参数说明：<BR>
point2data:  指向数据包内存地址的指针<BR>
length:  数据包的总长度<BR>
处理流程：<BR>
接口从MAC层收到数据后，根据IP报文头部信息中的目标地址判断，如果目标地址是本节点的IP地址，则将数据包上传给应用层；否则，处理转发流程，根据目标地址查找路由表，如果找到路由，则调用MAC层接口处理转发；如果没有找到路由，则丢弃数据包<BR>

